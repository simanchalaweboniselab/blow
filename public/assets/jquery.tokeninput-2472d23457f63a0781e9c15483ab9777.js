/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.4
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(a){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},d={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};a.fn.tokenInput=function(c,d){var e=a.extend({},b,d||{},{url:c});return this.each(function(){new a.TokenList(this,e)})},a.TokenList=function(b,f){function t(){if(k===(k=l.val()))return;var a=k.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");s.html(a),l.width(s.width()+30)}function u(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function v(b,c){var d=a("<li><p>"+c+"</p> </li>").addClass(f.classes.token).insertBefore(r);a("<span>"+f.deleteText+"</span>").addClass(f.classes.tokenDelete).appendTo(d).click(function(){return A(a(this).parent()),!1});var e={id:b,name:c};return a.data(d.get(0),"tokeninput",e),g.push(e),m.val(g.map(function(a){return a.id}).join(f.tokenDelimiter)),h+=1,d}function w(b){var c=a.data(b.get(0),"tokeninput"),d=f.onAdd;if(h>0&&f.preventDuplicates){var e=null;p.children().each(function(){var b=a(this),d=a.data(b.get(0),"tokeninput");if(d&&d.id===c.id)return e=b,!1});if(e){x(e),r.insertAfter(e),l.focus();return}}if(f.tokenLimit!==null&&h>=f.tokenLimit){l.hide(),B();return}v(c.id,c.name),l.val("").focus(),B(),a.isFunction(d)&&d(c)}function x(a){a.addClass(f.classes.selectedToken),n=a.get(0),l.val(""),B()}function y(a,b){a.removeClass(f.classes.selectedToken),n=null,b===d.BEFORE?r.insertBefore(a):b===d.AFTER?r.insertAfter(a):r.appendTo(p),l.focus()}function z(b){n===b.get(0)?y(b,d.END):(n&&y(a(n),d.END),x(b))}function A(b){var c=a.data(b.get(0),"tokeninput"),d=f.onDelete;b.remove(),n=null,l.focus(),g=a.grep(g,function(a){return a.id!==c.id}),m.val(g.map(function(a){return a.id}).join(f.tokenDelimiter)),h-=1,f.tokenLimit!==null&&l.show().val("").focus(),a.isFunction(d)&&d(c)}function B(){setTimeout(function(){q.hide().empty(),o=null},300)}function C(){f.searchingText&&q.html("<p>"+f.searchingText+"</p>").show()}function D(){f.hintText&&q.html("<p>"+f.hintText+"</p>").show()}function E(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function F(b,c){if(c&&c.length){q.empty();var d=a("<ul>").appendTo(q).mouseover(function(b){G(a(b.target).closest("li"))}).mousedown(function(b){return w(a(b.target).closest("li")),!1}).hide();a.each(c,function(c,e){var g=a("<li>"+E(e.name,b)+"</li>").appendTo(d);c%2?g.addClass(f.classes.dropdownItem):g.addClass(f.classes.dropdownItem2),c===0&&G(g),a.data(g.get(0),"tokeninput",{id:e.id,name:e.name})}),q.show(),f.animateDropdown?d.slideDown("fast"):d.show()}else f.noResultsText&&q.html("<p>"+f.noResultsText+"</p>").show()}function G(b){b&&(o&&H(a(o)),b.addClass(f.classes.selectedDropdownItem),o=b.get(0))}function H(a){a.removeClass(f.classes.selectedDropdownItem),o=null}function I(b){var c=l.val().toLowerCase();c&&c.length&&(n&&y(a(n),d.AFTER),c.length>=f.minChars?(C(),b?J(c):(clearTimeout(j),j=setTimeout(function(){J(c)},f.searchDelay))):B())}function J(b){var c=i.get(b);if(c)F(b,c);else{var d=function(c){a.isFunction(f.onResult)&&(c=f.onResult.call(this,c)),i.add(b,f.jsonContainer?c[f.jsonContainer]:c),l.val().toLowerCase()===b&&F(b,f.jsonContainer?c[f.jsonContainer]:c)},e={};e.data={};if(f.url.indexOf("?")>-1){var g=f.url.split("?");e.url=g[0];var h=g[1].split("&");a.each(h,function(a,b){var c=b.split("=");e.data[c[0]]=c[1]})}else e.url=f.url;e.data[f.queryParam]=b,e.type=f.method,e.success=d,e.dataType=f.contentType,f.crossDomain&&(e.dataType="jsonp"),a.ajax(e)}}f.crossDomain===undefined&&(f.crossDomain=location.href.split(/\/+/g)[1]!==f.url.split(/\/+/g)[1]),f.classes?f.classes=a.extend({},c,f.classes):f.theme?(f.classes={},a.each(c,function(a,b){f.classes[a]=b+"-"+f.theme})):f.classes=c;var g=[],h=0,i=new a.TokenList.Cache,j,k,l=a('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){(f.tokenLimit===null||f.tokenLimit!==h)&&D()}).blur(function(){B()}).bind("keyup keydown blur update",t).keydown(function(b){var c,f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!!a(this).val()){var g=null;return b.keyCode===e.DOWN||b.keyCode===e.RIGHT?g=a(o).next():g=a(o).prev(),g.length&&G(g),!1}c=r.prev(),f=r.next(),c.length&&c.get(0)===n||f.length&&f.get(0)===n?b.keyCode===e.LEFT||b.keyCode===e.UP?y(a(n),d.BEFORE):y(a(n),d.AFTER):b.keyCode!==e.LEFT&&b.keyCode!==e.UP||!c.length?(b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length&&x(a(f.get(0))):x(a(c.get(0)));break;case e.BACKSPACE:c=r.prev();if(!a(this).val().length)return n?A(a(n)):c.length&&x(a(c.get(0))),!1;a(this).val().length===1?B():setTimeout(function(){I(!1)},5);break;case e.TAB:case e.RETURN:case e.COMMA:if(o)return w(a(o)),!1;break;case e.ESC:return B(),!0;default:u(b.keyCode)&&setTimeout(function(){I(!1)},5)}}),m=a(b).hide().focus(function(){l.focus()}).blur(function(){l.blur()}),n=null,o=null,p=a("<ul />").addClass(f.classes.tokenList).insertBefore(m).click(function(b){var c=a(b.target).closest("li");if(c&&c.get(0)!==r.get(0))return z(c),!1;l.focus(),n&&y(a(n),d.END)}).mouseover(function(b){var c=a(b.target).closest("li");c&&n!==this&&c.addClass(f.classes.highlightedToken)}).mouseout(function(b){var c=a(b.target).closest("li");c&&n!==this&&c.removeClass(f.classes.highlightedToken)}).mousedown(function(b){var c=a(b.target).closest("li");if(c)return!1}),q=a("<div>").addClass(f.classes.dropdown).insertAfter(p).hide(),r=a("<li />").addClass(f.classes.inputToken).appendTo(p).append(l),s=a("<tester/>").insertAfter(l).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:l.css("fontSize"),fontFamily:l.css("fontFamily"),fontWeight:l.css("fontWeight"),letterSpacing:l.css("letterSpacing"),whiteSpace:"nowrap"});m.val(""),li_data=f.prePopulate,li_data&&li_data.length&&a.each(li_data,function(a,b){v(b.id,b.name)})},a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b),d={},e=0,f=function(){d={},e=0};this.add=function(a,b){e>c.max_size&&f(),d[a]||(e+=1),d[a]=b},this.get=function(a){return d[a]}}})(jQuery);